@using AlbertLlonguerasNew.Controllers
@using umbraco.cms.businesslogic.web
@using umbraco.BusinessLogic;
@using Member = umbraco.cms.businesslogic.member.Member
@model AlbertLlonguerasNew.Models.NewPorraModel

@{
    if (TempData["PorraSuccess"] == null || !Boolean.Parse(TempData["PorraSuccess"].ToString()))
    {
        var ddl = Library.Businness.TeamsManager.LoadTeams();
        using (Html.BeginUmbracoForm<NewPorraController>("CreatePorra"))
        {
    @Html.Label("Equip local")
    @Html.DropDownListFor(x => x.LocalTeam, new SelectList(ddl, "Team", "Team"))
    @Html.Raw("</br>")
    @Html.Label("Golejadors equip local")
    @Html.TextBoxFor(x => x.LocalScore)
    <p class="helpMessage">Els golejadors han d'estar separats per comes. Es deixa en blanc quan l'equip no marca gols</p>
    @Html.Raw("</br>")
    @Html.Label("Equip visitant")
    @Html.DropDownListFor(x => x.VisitorTeam, new SelectList(ddl, "Team", "Team"))
    @Html.Raw("</br>")
    @Html.Label("Golejadors equip visitant")
    @Html.TextBoxFor(x => x.VisitorScore)
    <p class="helpMessage">Els golejadors han d'estar separats per comes. Es deixa en blanc quan l'equip no marca gols</p>
            TempData["Player"] = Model.Player;
            TempData["PorraNode"] = Model.PorraNode;
            TempData["MatchIdentifier"] = Model.MatchIdentifier;
    @Html.Raw("</br>")
    @Html.Raw("</br>")
    <input type="submit" />
        }
    }
}
@{
    if (TempData["PorraSuccess"] != null && Boolean.Parse(TempData["PorraSuccess"].ToString()))
    {
        if (TempData["ErrorLog"] != null)
        {
            <p class="text-warning">@TempData["ErrorLog"]</p>
        }
        else
        {
            <p>@TempData["LocalTeam"]</p>
            <p>@TempData["LocalScore"]</p>
            <p>@TempData["VisitorTeam"]</p>
            <p>@TempData["VisitorScore"]</p>
            DocumentType dt = DocumentType.GetByAlias("Porra");
            var currentUser = Member.GetCurrentMember();
            User author = new User(0);
            Document doc = Document.MakeNew(@Model.MatchIdentifier, dt, currentUser.User, Model.PorraNode.Id);
            doc.getProperty("porraIdentifier").Value = Model.MatchIdentifier;
            doc.getProperty("localTeam").Value = TempData["LocalTeam"];
            doc.getProperty("localScore").Value = TempData["LocalScore"];
            doc.getProperty("visitorTeam").Value = TempData["VisitorTeam"];
            doc.getProperty("visitorScore").Value = TempData["VisitorScore"];
            doc.Publish(author);
        }
    }
}
